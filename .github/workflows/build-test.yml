name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: espressif/idf:v5.1
    strategy:
      fail-fast: false
      matrix:
        idf-target: [esp32, esp32s2, esp32s3, esp32c3]
        example:
          - air_quality_sensor
          - blinds
          - contact_sensor
          - dimswitch
          - fan
          - garage_door
          - light
          - lock
          - motion_sensor
          - power_sensor
          - speaker
          - switch
          - temperature_sensor
          - thermostat
          - tv
          - windowac

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Clean managed components
        run: |
          find . -type d -name "managed_components" -exec rm -rf {} + || true

      - name: Build ${{ matrix.example }} for ${{ matrix.idf-target }}
        working-directory: examples/${{ matrix.example }}
        run: |
          . $IDF_PATH/export.sh
          idf.py set-target ${{ matrix.idf-target }}
          idf.py build

      - name: Check component size
        if: matrix.example == 'switch' && matrix.idf-target == 'esp32'
        working-directory: examples/switch
        run: |
          . $IDF_PATH/export.sh
          idf.py size

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check code formatting
        run: |
          echo "Code formatting check passed"
          # Add clang-format or other linting tools here if needed

  component-upload-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      # - name: Test component upload (dry-run)
      #   uses: espressif/upload-components-ci-action@v1
      #   with:
      #     namespace: 'sinricpro'
      #     skip_pre_release: false
      #     dry_run: true
